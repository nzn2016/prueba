<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clip Overlay</title>
    <style>
        .clip-overlay {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 640px;
            height: 360px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .clip-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="clip-overlay" id="clipContainer">
        <div class="loading" id="loadingText">Cargando clip...</div>
        <iframe class="clip-iframe" id="clipFrame"></iframe>
    </div>

    <script>
        const CLIENT_ID = "yxawcq3tv58xxudlotl9okus7u3n2h";
        const CLIENT_SECRET = "cpd9auhw3esumq0jzf8ogon65flo03";
        let ACCESS_TOKEN = "";

        async function getAccessToken() {
            const response = await fetch(`https://id.twitch.tv/oauth2/token?client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&grant_type=client_credentials`, {
                method: "POST"
            });
            const data = await response.json();
            ACCESS_TOKEN = data.access_token;
        }

        async function getUserId(channel) {
            const response = await fetch(`https://api.twitch.tv/helix/users?login=${channel}`, {
                headers: {
                    'Authorization': `Bearer ${ACCESS_TOKEN}`,
                    'Client-Id': CLIENT_ID
                }
            });
            const data = await response.json();
            return data.data[0]?.id;
        }

        async function getRandomClip(channel) {
            try {
                const userId = await getUserId(channel);
                if (!userId) return null;

                const response = await fetch(`https://api.twitch.tv/helix/clips?broadcaster_id=${userId}&first=10`, {
                    headers: {
                        'Authorization': `Bearer ${ACCESS_TOKEN}`,
                        'Client-Id': CLIENT_ID
                    }
                });

                const data = await response.json();
                const clips = data.data;
                return clips.length > 0 ? clips[Math.floor(Math.random() * clips.length)] : null;
            } catch (error) {
                console.error("Error:", error);
                return null;
            }
        }

        function displayClip(clipId) {
            const container = document.getElementById("clipContainer");
            const iframe = document.getElementById("clipFrame");

            iframe.src = `https://clips.twitch.tv/embed?clip=${clipId}&parent=streamelements.com&parent=overlay.streamelements.com`;
            container.style.display = "block";
            document.getElementById("loadingText").style.display = "none";
        }

        window.addEventListener("onEventReceived", async (event) => {
            if (!event.detail.event) return;
            const { listener, event: eventData } = event.detail;

            if (listener === "message") {
                const message = eventData.data.text.toLowerCase();
                if (message.startsWith("!so ")) {
                    const channel = message.split(" ")[1].replace("@", "").trim();
                    if (channel) {
                        document.getElementById("loadingText").style.display = "block";
                        const clip = await getRandomClip(channel);
                        if (clip) {
                            displayClip(clip.id);
                        } else {
                            document.getElementById("loadingText").style.display = "none";
                        }
                    }
                }
            }
        });

        getAccessToken();
    </script>
</body>
</html>
